<!DOCTYPE html>
<meta charset="utf-8">
<style>
  circle {
    fill: #ccc;
    stroke: #333;
    stroke-width: 1.5px;
  }
</style>

<body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    var width = 960,
      height = 500;

    var state = {
      links: {
        count: 0
      },
      nodes: {
        count: 0
      },
      layers: {
        count: 0,
        
      }
    };

    /*
    layers: {
      count:0,
      "1":{
        x:
        y:
        width:
        height:
      }
    }
    */
    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

    svg.append("rect")
      .attr("x", 10)
      .attr("y", 10)
      .attr("width", 50)
      .attr("height", 50)
      .attr("class", "layerbtn")
      .style("stroke", "black")
      .style("fill", "red")
      .on("click", function() {
        context = "makelayer";
      });

    svg
      .append("circle")
      .attr("r", 10)
      .attr("cx", 90)
      .attr("cy", 20)
      .attr("class", 'nodebtn')
      .on("click", function() {
        context = "makenode";
      });

    var drawing = false;
    var context, make;

    d3.selection.prototype.first = function () {
      return d3.select(this[0][0]);
    };
    d3.selection.prototype.last = function () {
      var last = this.size() - 1;
      return d3.select(this[0][last]);
    };

    svg.on("click", function () {
      var coords = d3.mouse(this);
      console.log(state);
      if (d3.event.srcElement.tagName === "circle") {
        
      }
      else if(context==="makenode" && d3.event.srcElement.tagName === "rect") {
        let parentrectx = state.layers[d3.event.srcElement.className.baseVal].x;
        svg
          .append("circle")
          .attr("r", 6)
          .attr("cx", parentrectx)
          .attr("cy", coords[1])
          .attr("class", `${state.nodes.count}`)
          .on("click", function () {
            if (!drawing) {
              drawing = !drawing;
              circ1 = this.className.baseVal;
            }
            else {
              circ2 = this.className.baseVal;
              drawing = !drawing;
              svg.append("line")
                .attr("x1", state.nodes[circ1].x)
                .attr("y1", state.nodes[circ1].y)
                .attr("x2", state.nodes[circ2].x)
                .attr("y2", state.nodes[circ2].y)
                .attr("stroke-width", 2)
                .attr("stroke", "black");

              state.links.count++;
              state.links[state.links.count] = {
                first: circ1,
                second: circ2
              };
              console.log(state.links);
            }
          });
      }
      else if (context === "makelayer" && d3.event.srcElement.tagName === 'svg') {
        state.layers.count++;
        state.layers[state.layers.count] = {
          x: coords[0],
          y: coords[1],
          width: 50,
          height: 200
        };
        svg.append("rect")
          .attr("x", coords[0])
          .attr("y", coords[1])
          .attr("width", 50)
          .attr("height", 200)
          .attr("class", `layer${state.layers.count}`)
          .style("stroke", "black")
          .style("fill", "white");
          state.layers[d3.event.srcElement.className.baseVal] = {};
          state.layers[d3.event.srcElement.className.baseVal]["nodes"] = 0;
      }
      else {
        state.nodes.count++;
        state.nodes[state.nodes.count] = {
          x: coords[0],
          y: coords[1]
        };
        svg
          .append("circle")
          .attr("r", 6)
          .attr("cx", coords[0])
          .attr("cy", coords[1])
          .attr("class", `${state.nodes.count}`)
          .on("click", function () {
            if (!drawing) {
              drawing = !drawing;
              circ1 = this.className.baseVal;
            }
            else {
              circ2 = this.className.baseVal;
              drawing = !drawing;
              svg.append("line")
                .attr("x1", state.nodes[circ1].x)
                .attr("y1", state.nodes[circ1].y)
                .attr("x2", state.nodes[circ2].x)
                .attr("y2", state.nodes[circ2].y)
                .attr("stroke-width", 2)
                .attr("stroke", "black");

              state.links.count++;
              state.links[state.links.count] = {
                first: circ1,
                second: circ2
              };
              console.log(state.links);
            }
          });
      }
    });
  </script>